<!DOCTYPE html>
<!--
Copyright (C) 2017 arx iT

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/masterWithTable}">
    <head>
        <title>
            [[#{application.name}]]&nbsp;&ndash; [[${#messages.msg('requestDetails.page.title', request.label)}]]
        </title>
        <th:block layout:fragment="additionalStyleIncludes">
            <link rel="stylesheet" href="../../static/lib/ol/ol.css"
                  th:href="@{'/lib/ol/ol.css'} + '?v=@@openLayersLibVersion@@'" type="text/css" />
            <link rel="stylesheet" href="../../static/lib/ol-layerswitcher/src/ol-layerswitcher.css"
                  th:href="@{'/lib/ol-layerswitcher/src/ol-layerswitcher.css'} + '?v=@@layerSwitcherLibVersion@@'"
                  type="text/css" />
        </th:block>
    </head>
    <body>
        <div id="wrapper">
            <div id="page-wrapper" layout:fragment="content"
                 th:with="isAdmin = ${#authentication.principal.hasAuthority('ADMIN')},
                 showErrorBlock = ${request.taskInError or request.exportInError or (request.inError and isAdmin)},
                 showActionBlock = ${request.inStandby or showErrorBlock},
                 hasProcess = ${not #strings.isEmpty(request.processName)}">
                <div>
                    <div class="float-end">
                        <button id="requestCancelButton" class="btn btn-extract-white" th:text="#{buttons.close}"
                                type="button">
                            {Cancel}
                        </button>
                    </div>
                    <div class="page-header" style="margin-left: 0">
                        <h1 th:text="${#messages.msg('requestDetails.body.title', request.label)}">
                            {Request #12345}
                        </h1>
                        <div th:object="${request.connector}">
                            <span th:text="#{requestDetails.connector.label}">{Connector:}</span>&nbsp;
                            <a href="connectors/id" th:if="${isAdmin}" th:text="*{name}" th:href="@{'/connectors/' + *{id}}"
                                th:unless="${request.connector} == null">
                                {My connector}
                            </a>
                            <span th:unless="${isAdmin} or ${request.connector} == null" th:text="*{name}"></span>
                            <i th:if="${request.connector} == null" th:text="#{requestDetails.connector.deleted}">
                                {(Deleted)}
                            </i>
                        </div>
                    </div>
                </div>
                <div id="scheduledStopMessage" class="alert alert-dismissible alert-warning"
                     th:if="${orchestratorState} == 'SCHEDULED_STOP'">
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" data-bs-toggle="tooltip"
                            th:attr="aria-label=#{message.close}" th:title="#{message.close}" title="{Close}">
                    </button>
                    <div><strong th:text="#{orchestrator.status.stopped}"></strong></div>
                    <th:block th:text="#{orchestrator.status.scheduledStop}"></th:block>
                </div>
                <div id="stoppedMessage" class="alert alert-dismissible alert-warning"
                     th:if="${orchestratorState} == 'STOPPED'">
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" data-bs-toggle="tooltip"
                            th:attr="aria-label=#{message.close}" th:title="#{message.close}" title="{Close}">
                    </button>
                    <div><strong th:text="#{orchestrator.status.stopped}"></strong></div>
                    <th:block th:text="#{orchestrator.status.fullStop}"></th:block>
                </div>
                <div>
                    <h3 th:with="processString = ${hasProcess} ? ${request.processName} : #{requestDetails.process.none}"
                        th:text="${#messages.msg('requestDetails.process.title', processString)}"></h3>
                    <div class="progress split process-progress" th:if="${hasProcess}" role="progressbar">
                        <th:block th:each="historyItem, historyStats : ${request.processHistory}"
                                  th:object="${request.processHistory[__${historyStats.index}__]}" th:switch="*{status}"
                                  th:with="label = ${#strings.startsWith(#object.taskLabel, '##')}
                                  ? ${#messages.msg(#strings.substringAfter(#object.taskLabel, '##'))}
                                  : *{taskLabel}, size = ${historyStats.size}">
                            <div th:case="${T(ch.asit_asso.extract.domain.RequestHistoryRecord.Status).ERROR}"
                                 th:style="|width: calc((100% - ${size - 1} * 30px) / ${size})|"
                                 class="progress-bar bg-danger">
                                <i class="fa fa-warning"></i>
                                <span th:text="${label}"></span>

                            </div>
                            <div th:case="${T(ch.asit_asso.extract.domain.RequestHistoryRecord.Status).FINISHED}"
                                 th:style="|width: calc((100% - ${size - 1} * 30px) / ${size})|"
                                 class="progress-bar progress-bar-done">
                                <span th:text="${label}"></span>

                            </div>
                            <div th:case="${T(ch.asit_asso.extract.domain.RequestHistoryRecord.Status).ONGOING}"
                                 th:style="|width: calc((100% - ${size - 1} * 30px) / ${size})|"
                                 class="progress-bar progress-bar-current progress-bar-striped">
                                <span th:text="${label}"></span>
                            </div>
                            <div th:case="${T(ch.asit_asso.extract.domain.RequestHistoryRecord.Status).STANDBY}"
                                 th:style="|width: calc((100% - ${size - 1} * 30px) / ${size})|"
                                 class="progress-bar progress-bar-standby">
                                <span th:text="${label}"></span>
                            </div>
                            <div th:case="*" th:style="|width: calc((100% - ${size - 1} * 30px) / ${size})|"
                                 class="progress-bar progress-bar-todo">
                                <span th:text="${label}"></span>
                            </div>
                            <i class="separator" th:unless="${historyStats.last}"></i>
                        </th:block>
                    </div>
                </div>
                <div class="row caret-row" th:if="${showActionBlock and hasProcess}">
                    <div th:each="historyItem, historyStats : ${request.processHistory}"
                         th:style="'width: calc(100% /' + ${#arrays.length(request.processHistory)} + ')'" class="caret-cell">
                        <i class="fa fa-caret-up current-step-caret"
                           th:classappend="${request.inStandby} ? 'current-step-caret-standby'
                           : (${request.inError} ? 'current-step-caret-danger' : '')"
                           th:if="${historyStats.count} == ${request.currentProcessStep + 1}">
                        </i>
                    </div>
                </div>
                <div class="card card-body current-step current-step-error" th:if="${showErrorBlock}">
                    <h2 class="current-step-title" th:if="${request.importFail}"
                        th:text="${#messages.msg('requestDetails.currentStep.invalidProduct.title', request.connector.name, request.currentStepMessage)}">
                        {The product imported through the connector "My connector" cannot be processed : Invalid perimeter}
                    </h2>
                    <h2 class="current-step-title" th:if="${request.unmatched}"
                        th:text="${#messages.msg('requestDetails.currentStep.unmatched.title', request.connector.name)}">
                        {No matching for this request (connector "My connector")}
                    </h2>
                    <h2 class="current-step-title" th:if="${request.taskInError}"
                        th:text="${#messages.msg('requestDetails.currentStep.error.title', request.currentStepMessage)}">
                        {Error message : 500 Internal server error}
                    </h2>
                    <h2 class="current-step-title" th:if="${request.exportInError}"
                        th:text="${#messages.msg('requestDetails.currentStep.exportFail.title', request.currentStepMessage)}">
                        {Export failed : 500 Internal server error}
                    </h2>
                    <div class="row">
                        <div class="col-xl-6 current-step-action" th:if="${request.unmatched}">
                            <h3 th:text="#{requestDetails.currentStep.retryMatching.title}">{Retry}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.retryMatching.text}">
                                    {This will run the rule matching again.}
                                </p>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="errorRetryMatchingButton" class="btn btn-extract-filled"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/retryMatching'}">
                                    <i class="fa fa-retweet"></i>
                                    <span th:text="#{requestDetails.currentStep.retryMatching.button}">{Retry}</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-xl-3 current-step-action" th:if="${request.taskInError}">
                            <h3 th:text="#{requestDetails.currentStep.restartTask.title}">{Restart}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.restartTask.text}">
                                    {This will run the task again.}
                                </p>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="errorRestartButton" class="btn btn-extract-filled"
                                    th:attr="data-action=@{'/requests/' + ${request.id} + '/restartTask'}">
                                    <i class="fa fa-cog"></i>
                                    <span th:text="#{requestDetails.currentStep.restartTask.button}">{Restart}</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-xl-4 current-step-action" th:if="${request.exportInError}">
                            <h3 class="current-step-action-title"
                                th:text="#{requestDetails.currentStep.retryExport.title}">{Retry export}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.retryExport.text}">
                                    {This will run the export again.}
                                </p>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="errorRetryExportButton" class="btn btn-extract-filled"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/retryExport'}">
                                    <i class="fa fa-upload"></i>
                                    <span th:text="#{requestDetails.currentStep.retryExport.button}">{Retry}</span>
                                </button>
                            </div>
                        </div>
                        <div class="current-step-action"
                             th:if="${request.taskInError or request.exportInError}"
                             th:attrprepend="class = ${request.taskInError} ? 'col-xl-3 ' : 'col-xl-4 '">
                            <h3 class="current-step-action-title"
                                th:text="#{requestDetails.currentStep.restartProcess.title}">{Restart}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.restartProcess.text}">
                                    {This will run the process from the start.}
                                </p>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="errorRelaunchButton" class="btn btn-extract-filled"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/relaunch'}">
                                    <i class="fa fa-undo"></i>
                                    <span th:text="#{requestDetails.currentStep.restartProcess.button}">{Restart}</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-xl-3 current-step-action" th:if="${request.taskInError}">
                            <h3 class="current-step-action-title"
                                th:text="#{requestDetails.currentStep.skipTask.title}">{Skip}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.skipTask.text}">
                                    {This skip the current task and proceed to the next task.}
                                </p>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="errorSkipButton" class="btn btn-danger"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/skipTask'}">
                                    <i class="fa fa-arrow-right"></i>
                                    <span th:text="#{requestDetails.currentStep.skipTask.button}">{Skip}</span>
                                </button>
                            </div>
                        </div>
                        <div class="current-step-action"
                             th:attrprepend="class = ${request.unmatched} ? 'col-xl-6 ' : (${request.taskInError} ? 'col-xl-3 ' : 'col-xl-4 ')"
                             th:classappend="${#strings.equals(validationError, 'remark')} ? 'has-error'">
                            <h3 class="current-step-action-title" th:text="#{requestDetails.currentStep.reject.title}">
                                {Reject}
                            </h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.reject.text}">
                                    {The process will be canceled and the customer will be notified with your remark below.}
                                </p>
                                <textarea id="errorCancelRemark" class="form-control"
                                          th:classappend="${request.taskInError} ? 'task-error-reject-remark'"
                                          th:placeholder="#{requestDetails.currentStep.reject.remark.placeholder}"></textarea>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="errorCancelButton" class="btn btn-danger"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/reject'}">
                                    <i class="fa fa-remove"></i>
                                    <span th:text="#{requestDetails.currentStep.reject.button}">{Reject}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card card-body current-step current-step-standby" th:if="${request.inStandby}">
                    <div class="current-step-title">
                        <h2 th:text="#{requestDetails.currentStep.standby.title}">
                            {This process waits for an action.}
                        </h2>
                        <p th:unless="${#strings.isEmpty(request.currentStepMessage)}"
                           th:text="${#messages.msg('requestDetails.currentStep.standby.message', request.currentStepMessage)}">
                            {Plugin message : Please validate data}
                        </p>
                    </div>
                    <div class="card card-body validation-parameters-card"
                         th:unless="${request.validationFocusParameters} == null or ${#maps.isEmpty(request.validationFocusParameters)}">
                        <div class="mb-2" th:each="parameter : ${request.validationFocusParameters}" th:object="${parameter}">
                            <div class="strong" th:text="*{key}">{KEY}</div>
                            <div th:text="*{value}">{Value}</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xl-5 current-step-action">
                            <h3 class="current-step-action-title" th:text="#{requestDetails.currentStep.validate.title}">{Validate}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.validate.text}">
                                    {The process will go on. You can define or modify the remark to the customer below.}
                                </p>
                                <textarea id="standbyValidateRemark" th:text="${request.remark}" class="form-control"
                                          th:placeholder="#{requestDetails.currentStep.validate.remark.placeholder}"></textarea>
                                <select th:unless="${validationMessages == null}" id="validationMessagesList"
                                        class="remark-templates-list select2-container form-control select2">
                                    <option value="" disabled selected hidden
                                            th:text="#{requestDetails.currentStep.validate.templates.placeholder}">
                                        {--- Validation remarks templates ---}
                                    </option>
                                    <option th:each="template : ${validationMessages}" th:object="${template}" value="1"
                                            th:value="*{id}" th:text="*{title}">{My message title}</option>
                                </select>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="standbyValidateButton" class="btn btn-extract-filled"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/validate'}">
                                    <i class="fa fa-check"></i>
                                    <span th:text="#{requestDetails.currentStep.validate.button}">{Validate}</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-xl-5 current-step-action"
                             th:classappend="${#strings.equals(validationError, 'remark')} ? 'has-error'">
                            <h3 class="current-step-action-title" th:text="#{requestDetails.currentStep.reject.title}">{Reject}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.reject.text}">
                                    {The process will be canceled and the customer will be notified with your remark below.}
                                </p>
                                <textarea id="standbyCancelRemark" class="form-control"
                                          th:placeholder="#{requestDetails.currentStep.reject.remark.placeholder}"></textarea>
                                <select th:unless="${rejectionMessages == null}" id="rejectionMessagesList"
                                        class="remark-templates-list select2-container form-control select2"
                                        th:placeholder="#{requestDetails.currentStep.reject.templates.placeholder}">
                                    <option value="" disabled selected hidden
                                            th:text="#{requestDetails.currentStep.reject.templates.placeholder}">
                                        {--- Rejection remarks templates ---}
                                    </option>
                                    <option th:each="template : ${rejectionMessages}" th:object="${template}" value="1"
                                            th:value="*{id}" th:text="*{title}">{My message title}</option>
                                </select>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="standbyCancelButton" class="btn btn-danger"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/reject'}">
                                    <i class="fa fa-remove"></i>
                                    <span th:text="#{requestDetails.currentStep.reject.button}">{Reject}</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-xl-2 current-step-action">
                            <h3 class="current-step-action-title" th:text="#{requestDetails.currentStep.restartProcess.title}">{Restart}</h3>
                            <div class="current-step-action-content">
                                <p th:text="#{requestDetails.currentStep.restartProcess.text}">
                                    {This will run the process from the start.}
                                </p>
                            </div>
                            <div class="current-step-action-buttons">
                                <button type="button" id="standbyRestartButton" class="btn btn-secondary"
                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/relaunch'}">
                                    <i class="fa fa-undo"></i>
                                    <span th:text="#{requestDetails.currentStep.restartProcess.button}">{Restart}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <form id="actionForm" method="POST" action="#">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" id="requestId" name="requestId" th:value="${request.id}" />
                    <input type="hidden" id="requestLabel" name="requestLabel" th:value="${request.label}" />
                    <input type="hidden" id="currentStep" name="currentStep" th:value="${request.currentProcessStep}" />
                    <input type="hidden" id="remark" name="remark" />
                    <input type="hidden" id="targetFile" name="targetFile" />
                    <input type="file" id="filesToAdd" name="filesToAdd" multiple="multiple"
                           class="hidden-file-upload-control"/>
                </form>
                <div class="card card-default" th:if="${@features.perRequestOwnershipEnabled}">
                    <div class="card-header">
                        <b th:text="#{requestDetails.panels.ownership.title}">{Additional owners}</b>
                    </div>            
                    <div class="card-body">
                        <div class="form-group form-group-with-label">
                            <form id="requestOwnershipForm" method="POST" th:action="@{'/requests/' + ${request.id} + '/assign'}">
                                <label th:text="#{requestDetails.fields.operators.label}"
                                       class="form-label col-form-label">{Operators}</label>
                                <input id="usersIds" type="hidden" th:field="*{request.usersIds}" />
                                <input id="userGroupsIds" type="hidden" th:field="*{request.userGroupsIds}" />
                                <select class="select2-container select2-container-multi form-control select2 user-select"
                                        multiple="multiple" data-bs-toggle="tooltip"
                                        th:id="users">
                                    <optgroup th:unless="${#arrays.isEmpty(allusergroups)}" label="{Groups}"
                                              th:label="#{requestDetails.fields.operators.groups.label}">
                                        <option th:each="userGroup, userGroupStats : ${allusergroups}"
                                                th:value="|group-${userGroup.id}|">
                                            <span th:text="${userGroup.name}">{Group #1}</span>
                                        </option>
                                    </optgroup>
                                    <optgroup th:unless="${#arrays.isEmpty(allactiveusers)}" label="{Users}"
                                              th:label="#{requestDetails.fields.operators.users.label}">
                                        <option th:each="user, userStats : ${allactiveusers}"
                                                th:value="|user-${user.id}|">
                                            <span th:text="${user.name}">{User #1}</span>
                                        </option>
                                    </optgroup>
                                </select>
                                <div class="form-control-plaintext">
                                    <div th:unless="*{#arrays.isEmpty(userGroups)}">
                                        <th:block th:each="userGroup, userGroupsStats : *{userGroups}"
                                                  th:object="${process.userGroups[__${userGroupsStats.index}__]}">
                                            <span th:if="${userGroupsStats.index} > 0">&nbsp; - </span>
                                            <i class="fa fa-users"></i>&nbsp;
                                            <span th:text="*{name}">{User group}</span>
                                        </th:block>
                                    </div>
                                    <div th:unless="*{#arrays.isEmpty(users)}">
                                        <th:block th:each="user, usersStats : *{users}"
                                                  th:object="${process.users[__${usersStats.index}__]}"
                                                  >
                                            <span th:if="${usersStats.index} > 0">&nbsp; - </span>
                                            <i class="fa fa-user"></i>&nbsp;
                                            <span th:text="*{name}">{User}</span>
                                        </th:block>
                                    </div>
                                </div>
                           </form>
                       </div>
                       <div class="float-end">
                         <button id="usersSaveButton"
                                 class="btn btn-extract-filled"
                                 th:text="#{buttons.save}"
                                 type="button">
                            {Save}
                         </button>                                                    </div>
                    </div>
                </div>
                <div class="card card-default"
                     th:if="${request.waitingIntervention} or (not ${#strings.isEmpty(request.remark)}) or (${request.outputFiles != null} and not ${#arrays.isEmpty(request.outputFiles)})">
                    <div class="card-header">
                        <b th:text="#{requestDetails.panels.response.title}">{Response to the customer}</b>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-6">
                                <table class="list-table">
                                    <tr>
                                        <td><b th:text="#{requestDetails.remark.title}">{Remark:}</b>&nbsp;</td>
                                        <td class="preserve-whitespace" th:text="${request.remark}">{My remark}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-xl-6">
                                <table class="list-table files-list-table" th:unless="${request.finished}">
                                    <tr>
                                        <td><b th:text="#{requestDetails.files.title}">{Files:}</b>&nbsp;</td>
                                        <td>
                                            <div th:text="#{requestDetails.files.none}"
                                                 th:if="(not ${request.waitingIntervention}) and (${request.outputFiles == null} or ${#arrays.isEmpty(request.outputFiles)})">{(None)}</div>
                                            <div th:each="fileItem, fileStats : ${request.outputFiles}"
                                                 th:object="${request.outputFiles[__${fileStats.index}__]}"
                                                 th:unless="${fileStats.count == 0}">
                                                <a th:href="@{'/requests/' + ${request.id} + '/getFile?file=' + *{path}}"
                                                   href="#" th:text="*{name}" target="_blank">
                                                    {file.zip}
                                                </a>
                                                <span th:if="${request.waitingIntervention}">
                                                    <button class="file-delete-button" title="{Delete this file}"
                                                            th:title="#{requestDetails.files.delete}"
                                                            th:attr="data-action=@{'/requests/' + ${request.id} + '/deleteFile'},
                                                            data-file-path=*{path}">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </span>
                                            </div>
                                            <div class="files-button-container">
                                                <button type="button" id="file-upload-button"
                                                        class="btn btn-extract-filled file-upload-button"
                                                        th:text="#{requestDetails.files.add.button.label}"
                                                        th:if="${request.waitingIntervention}"
                                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/addFiles'}">
                                                    {Add files…}
                                                </button>
                                                <button type="button" id="file-download-button"
                                                        class="btn btn-extract-white file-download-button"
                                                        th:if="${request.waitingIntervention} and ${request.outputFiles != null} and ${request.outputFiles.length} > 1"
                                                        th:attr="data-action=@{'/requests/' + ${request.id} + '/getAllFiles'}">
                                                    <i class="fa fa-download"></i>
                                                    <span th:text="#{requestDetails.files.downloadAll.button.label}">
                                                        {Download all files…}
                                                    </span>
                                                </button>
                                            </div>
                                            <div class="mt-3" th:if="${isAdmin} or ${displayTempFolder}">
                                                <div class="strong" th:text="#{requestDetails.tempFolder.label}">
                                                    {Temp folders path:}
                                                </div>
                                                <div th:if="${request.outputFolderPath != null}" th:text="${request.outputFolderPath}">{/var/extract/data/my-request/output/}</div>
                                                <div th:if="${request.outputFolderPath == null}" th:text="#{requestDetails.tempFolder.notAvailable}">
                                                    {(Not available)}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card card-default">
                    <div class="card-header">
                        <span class="float-end" th:unless="${request.externalUrl == null}">
                            <a href="#" th:href="${request.externalUrl}" target="_blank"
                               th:text="#{requestDetails.orderDetails.link.text}">{View details}</a>
                        </span>
                        <b th:text="#{requestDetails.panels.orderDetails.title}">{Customer request}</b>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xl-4">
                                <h4 th:text="#{requestDetails.orderDetails.customer.title}">{Customer}</h4>
                                <div th:text="${request.organism}" th:unless="${#strings.isEmpty(request.organism)}">
                                    {Organism}
                                </div>
                                <div th:text="${request.customerName}">{Customer name}</div>
                                <div th:text="${request.customerDetails}" class="preserve-whitespace">
                                    {Customer details}
                                </div>
                            </div>
                            <div class="col-xl-4">
                                <th:block th:unless="${#strings.isEmpty(request.thirdPartyName)}">
                                    <h4 th:text="#{requestDetails.orderDetails.thirdParty.title}">{Third party}</h4>
                                    <div th:text="${request.thirdPartyName}">{Third party name}</div>
                                    <div th:text="${request.thirdPartyDetails}" class="preserve-whitespace">
                                        {Third party details}
                                    </div>
                                </th:block>
                            </div>
                            <div class="col-xl-4">
                                <h4 th:text="#{requestDetails.orderDetails.parameters.title}">{Parameters}</h4>
                                <div th:text="#{requestDetails.orderDetails.parameters.none}"
                                     th:if="${request.displayParameters} == null or ${#maps.isEmpty(request.displayParameters)}">{(None)}</div>
                                <div th:each="parameter : ${request.displayParameters}" th:object="${parameter}"
                                     th:unless="${request.displayParameters} == null or ${#maps.isEmpty(request.displayParameters)}">
                                    <span th:text="*{key}">{Parameter name}</span>:
                                    <b class="preserve-whitespace" th:text="*{value}">{Parameter value}</b>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 20px">
                            <div class="col-xl-12">
                                <h4>
                                    <span th:text="#{requestDetails.orderDetails.perimeter.title}">
                                        {Order perimeter}
                                    </span>
                                    (<span id="orderAreaSize"></span>)
                                </h4>
                                <div id="orderMap" class="map"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <h4 th:text="#{requestDetails.processHistory.title}">{Process history}</h4>
                <table class="table table-striped table-bordered table-hover dataTables dataTable">
                    <thead>
                        <tr>
                            <th th:text="#{requestDetails.processHistory.headers.startDate}">{Start}</th>
                            <th th:text="#{requestDetails.processHistory.headers.endDate}">{End}</th>
                            <th th:text="#{requestDetails.processHistory.headers.task}">{Task}</th>
                            <th th:text="#{requestDetails.processHistory.headers.statusMessage}">{Status/Message}</th>
                            <th th:text="#{requestDetails.processHistory.headers.user}">{User}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="historyEntry : ${request.fullHistory}">
                            <td th:text="${#calendars.format(historyEntry.startDate, 'yyyy-MM-dd HH:mm:ss')}">
                                {2017-05-04 12:54:08}
                            </td>
                            <td th:text="${historyEntry.endDate != null}
                                ? ${#calendars.format(historyEntry.endDate, 'yyyy-MM-dd HH:mm:ss')}">
                                {2017-05-04 12:57:34}
                            </td>
                            <td th:text="${historyEntry.taskLabel}">{My process task}</td>
                            <td class="history-status"
                                th:classappend="'history-status-' + ${#strings.toLowerCase(historyEntry.status.name())}">
                                <span th:text="${#messages.msg('historyRecord.status.' + historyEntry.status.name())}">
                                    {FINISHED}
                                </span>
                                <span th:unless="${#strings.isEmpty(historyEntry.message)}"
                                      th:text="' / ' + ${historyEntry.message}">{OK}</span>
                            </td>
                            <td th:with="user = ${historyEntry.user}"
                                th:text="${user != null} ? (${user.systemUser} ? #{default.users.system.name} : ${user.name})
                                : #{requestHistory.user.unknown.label}">{System}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="card card-default" th:if="${isAdmin}">
                    <div class="card-header">
                        <b>
                            <a data-bs-toggle="collapse" href="#adminToolsPanelBodyContainer" style="color:#333">
                                <span th:text="#{requestDetails.panels.adminTools.title}">{Administration}</span>
                                <i class="fa fa-caret-down"></i>
                            </a>
                        </b>
                    </div>
                    <div id="adminToolsPanelBodyContainer" class="card-collapse collapse">
                        <div class="card-body">
                            <div class="row admin-button-row">
                                <div class="col-xl-2">
                                    <button type="button" id="requestDeleteButton"
                                            class="btn btn-danger btn-sm admin-tool-button"
                                            th:attr="data-action = @{'/requests/' + ${request.id} + '/delete'}">
                                        <i class="fa fa-remove"></i>
                                        <span th:text="#{requestDetails.adminTools.delete.button.label}">
                                            {Delete permanently}
                                        </span>
                                    </button>
                                </div>
                                <div class="col-xl-10 admin-tool-label">
                                    <span th:text="#{requestDetails.adminTools.delete.description}">
                                        {Permanently delete this request}
                                    </span>
                                    <span th:text="#{requestDetails.adminTools.delete.description.noExport}"
                                          th:unless="${request.finished}">
                                        {It will not be sent back through the connector.}
                                    </span>
                                </div>
                            </div>
                            <div class="row admin-variable-row">
                                <div class="col-xl-3" th:text="#{requestDetails.fields.requestId.label}"></div>
                                <div th:text="${request.id}" class="col-xl-9 code code-green"></div>
                            </div>
                            <div class="row admin-variable-row">
                                <div class="col-xl-3" th:text="#{requestDetails.fields.productGuid.label}"></div>
                                <div th:text="${request.productGuid}" class="col-xl-9 code code-green"></div>
                            </div>
                            <div class="row admin-variable-row">
                                <div class="col-xl-3" th:text="#{requestDetails.fields.clientGuid.label}"></div>
                                <div th:text="${request.customerGuid}" class="col-xl-9 code code-green"></div>
                            </div>
                            <div class="row admin-variable-row">
                                <div class="col-xl-3" th:text="#{requestDetails.fields.organismGuid.label}"></div>
                                <div th:text="${request.organismGuid}" class="col-xl-9 code code-green"></div>
                            </div>
                            <div class="row admin-variable-row">
                                <div class="col-xl-3" th:text="#{requestDetails.fields.tiersGuid.label}"></div>
                                <div th:text="${request.tiersGuid}" class="col-xl-9 code code-green"></div>
                            </div>
                            <div class="row admin-variable-row">
                                <div class="col-xl-3" th:text="#{requestDetails.fields.orderLabel.label}"></div>
                                <div th:text="${request.orderLabel}" class="col-xl-9 code code-green"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:replace="fragments/alert :: alertModal"></div>
            </div>
        </div>
        <th:block layout:fragment="additionalScriptIncludes">
            <script type="text/javascript" src="../../static/lib/proj4/dist/proj4.js"
            th:src="@{/lib/proj4/dist/proj4.js} + '?v=@@proj4LibVersion@@'"></script>
            <script type="text/javascript" src="../../static/lib/ol/dist/ol.js"
            th:src="@{'/lib/ol/dist/ol.js'} + '?v=@@openLayersLibVersion@@'"></script>
            <script type="text/javascript" src="../../static/lib/ol-layerswitcher/dist/ol-layerswitcher.js"
            th:src="@{'/lib/ol-layerswitcher/dist/ol-layerswitcher.js'} + '?v=@@layerSwitcherLibVersion@@'"></script>
        </th:block>
        <th:block layout:fragment="additionalScripts">
            <script type="text/javascript" src="../../static/js/requestMap/map.js"
                    th:src="@{'/js/requestMap/' + ${mapDataFileName}} + '?v=@@extractVersion@@'">
            </script>
            <script type="text/javascript" src="../../static/js/requestDetails.js"
                    th:src="@{/js/requestDetails.js} + '?v=@@extractVersion@@'">
            </script>
            <script type="text/javascript" th:inline="javascript">
                var getRemarkTextUrl = /*[[@{/requests/getRemarkText}]]*/ './remarks/getText';
                var requestId = /*[[${request.id}]]*/ 1;

                $(function() {

                    $('#requestCancelButton').on('click', function() {
                        var listUrl = /*[[@{/requests}]]*/ '../requests';
                        location.replace(listUrl);
                    });

                    var orderGeometry = /*[[${request.perimeterGeometry}]]*/ '';
                    var geometryArea = /*[[${request.surface}]]*/ 0;
                    loadOrderGeometryMap(orderGeometry, geometryArea);

                    var historyTableProperties = getDataTableBaseProperties();
                    historyTableProperties.paging = false;
                    historyTableProperties.searching = false;
                    $(".dataTable").dataTable(historyTableProperties);
                });</script>
        </th:block>
    </body>
</html>
