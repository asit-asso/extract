<div>
    <p>Le plugin d'extraction FME Flow V2 (anciennement FME Server) permet d'ex&eacute;cuter des traitements de donn&eacute;es g&eacute;ospatiales sur un serveur FME Flow distant via API REST avec authentification par token.</p>

    <h4>MÃ©thode de fonctionnement</h4>
    <p>
        Ce plugin utilise le service FME Data Download pour ex&eacute;cuter des workspaces sur FME Flow.
        Il transmet les param&egrave;tres via GeoJSON dans le corps de la requ&ecirc;te POST et retourne un fichier ZIP contenant les r&eacute;sultats.
    </p>

    <h4>Configuration du workspace FME</h4>
    <p>Le workspace FME doit &ecirc;tre publi&eacute; sur FME Flow avec&nbsp;:</p>
    <ul>
        <li>Un param&egrave;tre publi&eacute; pour recevoir le GeoJSON (par d&eacute;faut : <code>GEOJSON_INPUT</code>)</li>
        <li>Configuration pour retourner les r&eacute;sultats via le service Data Download</li>
    </ul>

    <h4>Structure du GeoJSON transmis</h4>
    <p>Le plugin cr&eacute;e un objet GeoJSON de type Feature contenant&nbsp;:</p>
    <ul>
        <li><strong>geometry</strong> : La g&eacute;om&eacute;trie du p&eacute;rim&egrave;tre (conversion automatique du WKT en GeoJSON)</li>
        <li><strong>properties</strong> : Tous les param&egrave;tres de la requ&ecirc;te</li>
    </ul>

    <h4>Param&egrave;tres disponibles dans le GeoJSON</h4>
    <p>Les propri&eacute;t&eacute;s suivantes sont disponibles dans l'objet GeoJSON transmis au workspace&nbsp;:</p>

    <table class="popover-table parameter-table">
        <tbody>
            <tr>
                <td class="popover-table-header"><p>Param&egrave;tre</p></td>
                <td class="popover-table-header"><p>Description</p></td>
                <td class="popover-table-header"><p>Type</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>RequestId</p></td>
                <td class="popover-table-data"><p>Identifiant de la requ&ecirc;te Extract</p></td>
                <td class="popover-table-data"><p>Entier</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>ClientGuid</p></td>
                <td class="popover-table-data"><p>Identifiant unique du client</p></td>
                <td class="popover-table-data"><p>UUID</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>ClientName</p></td>
                <td class="popover-table-data"><p>Nom du client</p></td>
                <td class="popover-table-data"><p>Texte</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>OrganismGuid</p></td>
                <td class="popover-table-data"><p>Identifiant unique de l'organisme</p></td>
                <td class="popover-table-data"><p>UUID</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>OrganismName</p></td>
                <td class="popover-table-data"><p>Nom de l'organisme</p></td>
                <td class="popover-table-data"><p>Texte</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>ProductGuid</p></td>
                <td class="popover-table-data"><p>Identifiant unique du produit</p></td>
                <td class="popover-table-data"><p>UUID</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>ProductLabel</p></td>
                <td class="popover-table-data"><p>Libell&eacute; du produit</p></td>
                <td class="popover-table-data"><p>Texte</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>OrderGuid</p></td>
                <td class="popover-table-data"><p>Identifiant unique de la commande</p></td>
                <td class="popover-table-data"><p>UUID</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>OrderLabel</p></td>
                <td class="popover-table-data"><p>Libell&eacute; de la commande</p></td>
                <td class="popover-table-data"><p>Texte</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>Surface</p></td>
                <td class="popover-table-data"><p>Surface approximative en m&egrave;tres carr&eacute;s</p></td>
                <td class="popover-table-data"><p>Nombre d&eacute;cimal</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>Parameters</p></td>
                <td class="popover-table-data"><p>Param&egrave;tres personnalis&eacute;s</p></td>
                <td class="popover-table-data"><p>Objet JSON</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>FolderIn</p></td>
                <td class="popover-table-data"><p>R&eacute;pertoire des donn&eacute;es d'entr&eacute;e</p></td>
                <td class="popover-table-data"><p>Chemin</p></td>
            </tr>
            <tr>
                <td class="popover-table-data"><p>FolderOut</p></td>
                <td class="popover-table-data"><p>R&eacute;pertoire de sortie</p></td>
                <td class="popover-table-data"><p>Chemin</p></td>
            </tr>
        </tbody>
    </table>

    <h4>G&eacute;om&eacute;trie</h4>
    <p>
        La g&eacute;om&eacute;trie du p&eacute;rim&egrave;tre est automatiquement convertie du format WKT (WGS84) vers GeoJSON.
        Les types suivants sont support&eacute;s :
    </p>
    <ul>
        <li>Polygon (avec support des trous/donuts)</li>
        <li>MultiPolygon</li>
        <li>Point</li>
        <li>LineString</li>
    </ul>

    <h4>Exemple de body GeoJSON</h4>
    <pre>{
  "type": "Feature",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [6.886727, 46.443720],
      [6.881351, 46.441265],
      [6.886480, 46.439198],
      [6.893221, 46.441705],
      [6.886727, 46.443720]
    ]]
  },
  "properties": {
    "RequestId": 123,
    "ClientGuid": "94d47632-b0e9-57f4-6580-58925e3f9a88",
    "ClientName": "Jean Dupont",
    "OrganismGuid": "2edc1a50-4837-4c44-1519-3ebc85f14588",
    "OrganismName": "Service du cadastre",
    "ProductGuid": "a049fecb-30d9-9124-ed41-068b566a0855",
    "ProductLabel": "Plan cadastral",
    "OrderGuid": "5382e46f-9d5d-4fdd-adbc-828165d4be82",
    "OrderLabel": "221587",
    "Surface": 152384.56,
    "Parameters": {
      "FORMAT": "SHP",
      "PROJECTION": "EPSG:2056"
    },
    "FolderIn": "/data/input/",
    "FolderOut": "/data/output/"
  }
}</pre>

    <h4>Configuration du workspace FME</h4>
    <p>
        Le workspace FME Flow doit &ecirc;tre configur&eacute; pour utiliser le service Data Download :
    </p>
    <ul>
        <li>Publier le workspace dans un repository FME Flow</li>
        <li>Configurer un param&egrave;tre publi&eacute; pour recevoir le GeoJSON (ex: GEOJSON_INPUT)</li>
        <li>Utiliser un Reader GeoJSON ou JSONFeatureReader pour lire les donn&eacute;es du param&egrave;tre</li>
        <li>Configurer les Writers pour produire des fichiers de sortie</li>
        <li>Le service Data Download cr&eacute;era automatiquement un ZIP avec les r&eacute;sultats</li>
    </ul>
    
    <h4>URL du service</h4>
    <p>
        L'URL doit suivre le format standard du Data Download Service :
    </p>
    <pre>https://&lt;serveur&gt;/fmedatadownload/&lt;repository&gt;/&lt;workspace&gt;.fmw</pre>
    <p>
        Exemple : <code>https://fme.example.com/fmedatadownload/extract/ProcessGeoData.fmw</code>
    </p>

    <h4>S&eacute;curit&eacute;</h4>
    <p>
        Ce plugin impl&eacute;mente plusieurs mesures de s&eacute;curit&eacute; :
    </p>
    <ul>
        <li>Validation des URLs pour pr&eacute;venir les attaques SSRF</li>
        <li>Token API transmis de mani&egrave;re s&eacute;curis&eacute;e dans le header</li>
        <li>Limite de taille pour les t&eacute;l&eacute;chargements (500 MB)</li>
        <li>Timeouts pour &eacute;viter les blocages</li>
        <li>Retry automatique avec backoff exponentiel</li>
        <li>Validation et sanitisation de toutes les entr&eacute;es</li>
    </ul>

    <h4>R&eacute;sultat</h4>
    <p>
        Le plugin t&eacute;l&eacute;charge automatiquement le fichier ZIP r&eacute;sultat dans le r&eacute;pertoire de sortie.
        Le nom du fichier est g&eacute;n&eacute;r&eacute; automatiquement avec un timestamp pour &eacute;viter les conflits.
    </p>

    <h4>Gestion des erreurs</h4>
    <p>
        Le plugin g&egrave;re les erreurs suivantes :
    </p>
    <ul>
        <li>URL de service invalide ou inaccessible</li>
        <li>Token API invalide ou expir&eacute;</li>
        <li>G&eacute;om&eacute;trie WKT invalide</li>
        <li>Timeout de la requ&ecirc;te</li>
        <li>Fichier r&eacute;sultat trop volumineux</li>
        <li>Erreurs HTTP (avec retry automatique pour les erreurs 5xx)</li>
    </ul>
</div>