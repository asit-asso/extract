<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Aide - Plugin FME Server V2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            color: #333;
        }
        h1, h2 {
            color: #2c5282;
        }
        h1 {
            border-bottom: 2px solid #2c5282;
            padding-bottom: 10px;
        }
        .parameter {
            background-color: #f7fafc;
            border-left: 4px solid #3182ce;
            padding: 10px;
            margin: 10px 0;
        }
        .parameter-name {
            font-weight: bold;
            color: #2d3748;
        }
        .required {
            color: #e53e3e;
            font-weight: bold;
        }
        .optional {
            color: #38a169;
            font-weight: bold;
        }
        code {
            background-color: #edf2f7;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .example {
            background-color: #f0fff4;
            border: 1px solid #9ae6b4;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning {
            background-color: #fffbeb;
            border: 1px solid #f6e05e;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .error {
            background-color: #fed7d7;
            border: 1px solid #fc8181;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        ul {
            margin: 10px 0;
            padding-left: 30px;
        }
        li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Plugin FME Server V2 - Guide d'utilisation</h1>

    <h2>Description</h2>
    <p>
        Le plugin FME Server V2 permet d'exécuter des tâches de traitement de données géospatiales via FME Server ou FME Flow.
        Cette version améliorée utilise le format GeoJSON pour transmettre les paramètres géométriques et supporte
        l'authentification par token API ou nom d'utilisateur/mot de passe.
    </p>

    <h2>Fonctionnalités principales</h2>
    <ul>
        <li><strong>Support GeoJSON</strong> : Transmission des géométries au format GeoJSON standard</li>
        <li><strong>Authentification flexible</strong> : Token API ou authentification basique</li>
        <li><strong>Modes d'exécution</strong> : Synchrone et asynchrone</li>
        <li><strong>Compatibilité</strong> : FME Server et FME Flow</li>
        <li><strong>Sécurité renforcée</strong> : Protection SSRF, validation des URLs, limites de taille</li>
        <li><strong>Gestion d'erreurs</strong> : Messages d'erreur détaillés et retry automatique</li>
    </ul>

    <h2>Configuration des paramètres</h2>

    <div class="parameter">
        <div class="parameter-name">URL du service <span class="required">(obligatoire)</span></div>
        <p>URL complète du service FME Data Download incluant le répertoire et l'espace de travail.</p>
        <div class="example">
            <strong>Exemple :</strong><br>
            <code>http://fmeserver.example.com/fmedatadownload/REPOSITORY/workspace.fmw</code><br>
            <code>https://fmeflow.example.com/fmedatadownload/MyRepo/ExtractData.fmw</code>
        </div>
    </div>

    <div class="parameter">
        <div class="parameter-name">Token API <span class="optional">(optionnel)</span></div>
        <p>Token d'authentification pour accéder à FME Server/Flow. Recommandé pour la sécurité.</p>
        <div class="example">
            <strong>Comment obtenir un token :</strong>
            <ol>
                <li>Connectez-vous à FME Server/Flow</li>
                <li>Allez dans "Manage" → "Security" → "API Keys"</li>
                <li>Créez un nouveau token avec les permissions appropriées</li>
                <li>Copiez le token généré dans ce champ</li>
            </ol>
        </div>
    </div>

    <div class="parameter">
        <div class="parameter-name">Nom d'utilisateur <span class="optional">(optionnel)</span></div>
        <p>Nom d'utilisateur pour l'authentification basique. Alternative au token API.</p>
    </div>

    <div class="parameter">
        <div class="parameter-name">Mot de passe <span class="optional">(optionnel)</span></div>
        <p>Mot de passe correspondant au nom d'utilisateur. Utilisé avec l'authentification basique.</p>
    </div>

    <div class="parameter">
        <div class="parameter-name">Paramètre GeoJSON <span class="optional">(optionnel)</span></div>
        <p>Nom du paramètre publié dans l'espace de travail FME qui recevra le GeoJSON.</p>
        <p><strong>Valeur par défaut :</strong> <code>GEOJSON_INPUT</code></p>
        <div class="warning">
            <strong>Important :</strong> Votre espace de travail FME doit avoir un paramètre publié avec ce nom
            pour recevoir les données géométriques au format GeoJSON.
        </div>
    </div>

    <div class="parameter">
        <div class="parameter-name">Mode d'exécution <span class="optional">(optionnel)</span></div>
        <p>Détermine comment le service sera exécuté :</p>
        <ul>
            <li><strong>Synchrone</strong> : Attendre la completion et retourner le résultat immédiatement</li>
            <li><strong>Asynchrone</strong> : Démarrer le job et faire un polling du statut</li>
        </ul>
        <p><strong>Valeur par défaut :</strong> Synchrone</p>
    </div>

    <h2>Configuration de l'espace de travail FME</h2>

    <h3>Paramètres requis</h3>
    <p>Votre espace de travail FME doit être configuré avec un paramètre publié pour recevoir le GeoJSON :</p>

    <div class="example">
        <strong>Configuration du paramètre dans FME Workbench :</strong>
        <ol>
            <li>Ouvrez votre espace de travail dans FME Workbench</li>
            <li>Allez dans "Navigator" → "User Parameters"</li>
            <li>Créez un nouveau paramètre :
                <ul>
                    <li><strong>Nom :</strong> <code>GEOJSON_INPUT</code> (ou le nom configuré)</li>
                    <li><strong>Type :</strong> Text</li>
                    <li><strong>Publié :</strong> Oui</li>
                    <li><strong>Optional :</strong> Non</li>
                </ul>
            </li>
            <li>Utilisez ce paramètre avec un reader GeoJSON ou JSONFlattener</li>
        </ol>
    </div>

    <h3>Format des données GeoJSON</h3>
    <p>Le plugin transmet un objet GeoJSON Feature avec :</p>
    <ul>
        <li><strong>geometry :</strong> Géométrie convertie depuis WKT</li>
        <li><strong>properties :</strong> Toutes les informations de la requête</li>
    </ul>

    <div class="example">
        <strong>Exemple de structure GeoJSON envoyée :</strong>
        <pre><code>{
  "type": "Feature",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[[x1,y1],[x2,y2],...]]
  },
  "properties": {
    "RequestId": "123",
    "ClientName": "Client XYZ",
    "ProductLabel": "Produit ABC",
    "Parameters": { ... },
    "Surface": 15000.5
  }
}</code></pre>
    </div>

    <h2>Gestion des erreurs communes</h2>

    <div class="error">
        <strong>Erreur 401 - Non autorisé</strong><br>
        Vérifiez que votre token API est valide ou que vos identifiants nom d'utilisateur/mot de passe sont corrects.
    </div>

    <div class="error">
        <strong>Erreur 404 - Service non trouvé</strong><br>
        Vérifiez que l'URL du service est correcte et que l'espace de travail existe dans le répertoire spécifié.
    </div>

    <div class="error">
        <strong>Erreur de paramètre GeoJSON</strong><br>
        Assurez-vous que votre espace de travail FME a un paramètre publié avec le nom spécifié pour recevoir le GeoJSON.
    </div>

    <div class="warning">
        <strong>Timeouts</strong><br>
        Les processus longs peuvent dépasser le timeout. Considérez utiliser le mode asynchrone pour les traitements
        de longue durée.
    </div>

    <h2>Sécurité</h2>
    <ul>
        <li>Les tokens API et mots de passe ne sont jamais loggés</li>
        <li>Protection SSRF : les URLs vers localhost et réseaux privés sont bloquées</li>
        <li>Limite de taille : les téléchargements sont limités à 500 MB par défaut</li>
        <li>Validation des URLs : seuls HTTP et HTTPS sont autorisés</li>
        <li>Retry avec backoff exponentiel pour éviter la surcharge du serveur</li>
    </ul>

    <h2>Support et dépannage</h2>
    <p>En cas de problème :</p>
    <ol>
        <li>Vérifiez les logs d'Extract pour des messages d'erreur détaillés</li>
        <li>Testez la connexion à votre serveur FME manuellement</li>
        <li>Vérifiez que l'espace de travail fonctionne via l'interface FME Server</li>
        <li>Validez que le paramètre GeoJSON est correctement configuré</li>
    </ol>

    <div class="example">
        <strong>Test manuel de l'URL :</strong><br>
        Vous pouvez tester votre URL de service en l'ouvrant dans un navigateur :
        <code>http://votre-serveur/fmedatadownload/repo/workspace.fmw?opt_responseformat=json</code>
    </div>
</body>
</html>