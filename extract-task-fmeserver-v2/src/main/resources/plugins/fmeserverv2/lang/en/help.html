<div>
    <p>The FME Flow V2 extraction plugin (formerly FME Server) allows executing geospatial data processing on a remote FME Flow server via REST API with token authentication.</p>

    <h4>Operating Method</h4>
    <p>
        This plugin uses the FME Data Download service to execute workspaces on FME Flow.
        It transmits parameters via GeoJSON in the POST request body and returns a ZIP file containing the results.
    </p>

    <h4>FME Workspace Configuration</h4>
    <p>
        The FME Flow workspace must be configured to use the Data Download service:
    </p>
    <ul>
        <li>Publish the workspace in an FME Flow repository by uploading all data necessary for your script</li>
        <li>Select the <i>Data Download</i> service</li>
        <li>Use a GeoJSON Reader or FeatureReader to read the data contained in the request body. The parameter containing the GeoJSON reader source must be published but not mandatory. In the <i>Data Download</i> service configuration, select the GeoJSON reader in the Send HTTP Message <i>Body to Reader</i> field.</li>
        <li>Configure Writers to produce output files. The location of the output files is not important.</li>
        <li>The Data Download service will automatically create a ZIP with the results</li>
    </ul>

    <h4>Service URL</h4>
    <p>
        The URL must follow the standard Data Download Service format:
    </p>
    <pre>https://&lt;server&gt;/fmedatadownload/&lt;repository&gt;/&lt;workspace&gt;.fmw</pre>
    <p>
        Example: <code>https://fme.example.com/fmedatadownload/extract/ProcessGeoData.fmw</code>
    </p>

    <h4>Transmitted GeoJSON Structure</h4>
    <p>The plugin creates a GeoJSON Feature object containing:</p>
    <ul>
        <li><strong>geometry</strong>: The perimeter geometry in WGS84 (automatic conversion from WKT to GeoJSON)</li>
        <li><strong>properties</strong>: All request parameters</li>
    </ul>

    <h4>Available Parameters in the GeoJSON</h4>
    <p>The following properties are available in the GeoJSON object transmitted to the workspace:</p>

    <table class="popover-table parameter-table">
        <tbody>
        <tr>
            <td class="popover-table-header">
                <p>Parameter</p>
            </td>

            <td class="popover-table-header">
                <p>Description</p>
            </td>
            <td class="popover-table-header">
                <p>Type</p>
            </td>
            <td class="popover-table-header">
                <p>Example</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>Request</p>
            </td>
            <td class="popover-table-data">
                <p>Internal Extract order identifier</p>
            </td>
            <td class="popover-table-data">
                <p>Integer</p>
            </td>
            <td class="popover-table-data">
                <p>365</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>FolderOut</p>
            </td>
            <td class="popover-table-data">
                <p>Output directory where created files should be written</p>
            </td>
            <td class="popover-table-data">
                <p>String</p>
            </td>
            <td class="popover-table-data">
                <p>/var/extract/orders/5382e46f-9d5d-4fdd-adbc-828165d4be82/output/</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>OrderGuid</p>
            </td>
            <td class="popover-table-data">
                <p>Unique order identifier</p>
            </td>
            <td class="popover-table-data">
                <p>GUID / UUID</p>
            </td>
            <td class="popover-table-data">
                <p>5382e46f-9d5d-4fdd-adbc-828165d4be82</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>OrderLabel</p>
            </td>
            <td class="popover-table-data">
                <p>External order label</p>
            </td>
            <td class="popover-table-data">
                <p>Text</p>
            </td>
            <td class="popover-table-data">
                <p>221587</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>ClientGuid</p>
            </td>
            <td class="popover-table-data">
                <p>Unique client identifier</p>
            </td>
            <td class="popover-table-data">
                <p>GUID / UUID</p>
            </td>
            <td class="popover-table-data">
                <p>94d47632-b0e9-57f4-6580-58925e3f9a88</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>ClientName</p>
            </td>
            <td class="popover-table-data">
                <p>Name of the client who placed the order</p>
            </td>
            <td class="popover-table-data">
                <p>Text</p>
            </td>
            <td class="popover-table-data">
                <p>Jean Dupont</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>OrganismGuid</p>
            </td>
            <td class="popover-table-data">
                <p>Unique organization identifier</p>
            </td>
            <td class="popover-table-data">
                <p>GUID / UUID</p>
            </td>
            <td class="popover-table-data">
                <p>2edc1a50-4837-4c44-1519-3ebc85f14588</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>OrganismName</p>
            </td>
            <td class="popover-table-data">
                <p>Organization name</p>
            </td>
            <td class="popover-table-data">
                <p>Text</p>
            </td>
            <td class="popover-table-data">
                <p>Land Registry Office</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>ProductGuid</p>
            </td>
            <td class="popover-table-data">
                <p>Unique identifier of the ordered product</p>
            </td>
            <td class="popover-table-data">
                <p>GUID / UUID</p>
            </td>
            <td class="popover-table-data">
                <p>a049fecb-30d9-9124-ed41-068b566a0855</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>ProductLabel</p>
            </td>
            <td class="popover-table-data">
                <p>Label of the ordered product</p>
            </td>
            <td class="popover-table-data">
                <p>Text</p>
            </td>
            <td class="popover-table-data">
                <p>Cadastral plan</p>
            </td>
        </tr>
        <tr>
            <td class="popover-table-data">
                <p>Parameters</p>
            </td>
            <td class="popover-table-data">
                <p>JSON object containing custom request parameters</p>
            </td>
            <td class="popover-table-data">
                <p>JSON Object</p>
            </td>
            <td class="popover-table-data">
                <p>{"FORMAT" : "SHP", "PROJECTION" : "SWITZERLAND95"}</p>
            </td>
        </tr>
        </tbody>
    </table>

    <h4>Example of GeoJSON body</h4>
    <pre>{
  "type": "Feature",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [6.886727164248283, 46.44372031957538],
      [6.881351862162561, 46.44126511019801],
      [6.886480507180103, 46.43919870486726],
      [6.893221678307809, 46.441705238743005],
      [6.886727164248283, 46.44372031957538]
    ]]
  },
  "properties": {
    "Request": 365,
    "FolderOut": "/var/extract/orders/5382e46f-9d5d-4fdd-adbc-828165d4be82/output/",
    "OrderGuid": "5382e46f-9d5d-4fdd-adbc-828165d4be82",
    "OrderLabel": "221587",
    "ClientGuid": "94d47632-b0e9-57f4-6580-58925e3f9a88",
    "ClientName": "Jean Dupont",
    "OrganismGuid": "2edc1a50-4837-4c44-1519-3ebc85f14588",
    "OrganismName": "Land Registry Office",
    "ProductGuid": "a049fecb-30d9-9124-ed41-068b566a0855",
    "ProductLabel": "Cadastral plan",
    "Parameters": {
      "FORMAT": "SHP",
      "SELECTION" : "PASS_THROUGH",
      "PROJECTION" : "SWITZERLAND95",
      "REMARK" : "bla bla bla",
      "CLIENT_LANG" : "fr"
    }
  }
}</pre>

    <h4>Security</h4>
    <p>
        This plugin implements several security measures:
    </p>
    <ul>
        <li>URL validation to prevent SSRF attacks</li>
        <li>API token transmitted securely in the header</li>
        <li>Automatic retry with exponential backoff</li>
        <li>Validation and sanitization of all inputs</li>
    </ul>

    <h4>Result</h4>
    <p>
        The plugin automatically downloads the resulting ZIP file to the output directory.
        The filename is automatically generated with a timestamp to avoid conflicts.
    </p>

    <h4>Error Handling</h4>
    <p>
        The plugin handles the following errors:
    </p>
    <ul>
        <li>Invalid or inaccessible service URL</li>
        <li>Invalid or expired API token</li>
        <li>Invalid WKT geometry</li>
        <li>HTTP errors (with automatic retry for 5xx errors)</li>
    </ul>
</div>
